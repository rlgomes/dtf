<?xml version="1.0" encoding="UTF-8"?>

<script xmlns="http://dtf.org/v1" name="lockcomponent">
    <info>
         <author>
             <name>Rodney Gomes</name>
             <email>rlgomes@yahoo-inc.com</email>
         </author> 
         <description>
         Validates that lockcomponent/unlockcomponent works correctly from 
         within the same script or even having it happen in another script and 
         having to count on the framework to unlock the necessary components.
         </description>
    </info>
    
    <local>
        <createstorage id="INPUT" path="${dtf.xml.path}/input"/>
        <createstorage id="OUTPUT" path="${dtf.xml.path}/output"/>
        
        <loadproperties uri="storage://INPUT/ut.properties"/>
    </local>
    
    <createrange name="ids" value="1..3" recycle="true"/>
    <parallelloop property="thread" range="1..3">
        <for property="iteration" range="0..5">
            <local>
                <lockcomponent id="DTFA${thread}" timeout="10s">
                    <attrib name="node.id" value="${ids}"/>
                </lockcomponent>
                <unlockcomponent id="DTFA${thread}"/>
            </local>
        </for>
    </parallelloop>

    <!-- creating a testsuite here so that we avoid counting the N calls to 
         occupy_component as individual results -->
    <testsuite name="lockcomponent">
	    <log>now locking/unlocking in another script...</log>
	    <parallelloop property="thread" range="1..3">
	        <for property="iteration" range="1..10">
	            <property name="occupy.duration" value="0s"/>
	            <testscript uri="storage://INPUT/occupy_component.xml"/>
	        </for>
	    </parallelloop>
    </testsuite>
    
    <!-- Make sure the round-robin locking/unlocking is working  -->
    <property name="previous" value="none"/>
    <for property="iteration" range="1..10">
        <local>
            <lockcomponent id="DTFA" timeout="10s"/>
        </local>
        <if>
            <eq op1="${previous}" op2="${DTFA.node.id}"/>
            <then>
                <fail>Locked the same component twice in a row!</fail>
            </then>
        </if>
        <property name="previous" value="${DTFA.node.id}" overwrite="true"/>
        
        <local>
            <unlockcomponent id="DTFA"/>
        </local>
    </for>
    
    <!-- call other script that locks all 3 available components in a 
         parallelloop and validate this script can still lock components
         afterwards -->
    <property name="agents" value="3" overwrite="true"/>
    <testscript uri="storage://INPUT/parallel_occupy_component.xml"/>

    <local>
        <lockcomponent id="C1" timeout="2s"/>     
        <unlockcomponent id="C1"/>
    </local>

    <!-- call other script that locks all 3 available components in a 
         function and validate this script can still lock components afterwards 
    -->
    <property name="agents" value="3" overwrite="true"/>
    <testscript uri="storage://INPUT/function_occupy_component.xml"/>

    <local>
        <lockcomponent id="C1" timeout="5s"/>     
        <unlockcomponent id="C1"/>
    </local>
    
</script>