<?xml version="1.0" encoding="UTF-8"?>

<script xmlns="http://dtf.org/v1" name="exec">
    <info>
        <author>
            <name>Rodney Gomes</name>
            <email>rlgomes@yahoo-inc.com</email>
        </author>
        <description>DTF unit test for exec tag.</description>
    </info>
    
    <local>
        <createstorage id="INPUT" path="${dtf.xml.path}/input"/>
        <loadproperties uri="storage://INPUT/ut.properties"/>
        
        <lockcomponent id="C1"></lockcomponent>
    </local>
    
    <function name="checkExec" export="true">
        <param name="command" type="required"/>
        <param name="shouldfail" default="false"/>
       
        <log level="error">${exec.stderr}</log>
        <log>${exec.stdout}</log>
        <if>
            <eq op1="${shouldfail}" op2="true"/>
            <then>
                <if>
    		        <eq op1="${exec.rc}" op2="0"/>
    		        <then>
                        <fail>
                        ${command} should have failed,
                        but got return code ${exec.rc}
                        </fail>
    		        </then>
    		    </if>
            </then>
            <else>
    		    <if>
    		        <neq op1="${exec.rc}" op2="0"/>
    		        <then>
                        <fail>
                        ${command} should have succeeded,
                        but got return code ${exec.rc}
                        </fail>
    		        </then>
    		    </if>
            </else>
       </if>
    </function>

    <exec executable="ls">
        <arg value="-l"/>
    </exec>
    <call function="checkExec">
        <property name="command" value="ls -l"/>
    </call>

    <exec command="ls -l"/>
    <call function="checkExec">
        <property name="command" value="ls -l"/>
    </call>

    <exec command="cat">
        <input uri="storage://INPUT/testfile.utf8"/>
    </exec>
    <call function="checkExec">
        <property name="command" value="echo"/>
    </call>

    <exec command="cat">
        <input>TESTING</input>
    </exec>
    <call function="checkExec">
        <property name="command" value="echo"/>
    </call>

    <exec executable="sudo"/>
    <call function="checkExec">
        <property name="command" value="sudo"/>
        <property name="shouldfail" value="true"/>
    </call>

    <try>
        <sequence>
	        <exec executable="badcommand"/>
	        <fail>Previous command should have failed.</fail>
        </sequence>
        <catch exception="${java.IOException}">
            <log>Failed as expected</log>
        </catch>
    </try>

    <!-- remote -->
    <component id="C1">
	    <exec executable="ls">
	        <arg value="-l"/>
	    </exec>
	    <call function="checkExec">
	        <property name="command" value="ls -l"/>
	    </call>
	
	    <exec executable="sudo"/>
	    <call function="checkExec">
	        <property name="command" value="sudo"/>
	        <property name="shouldfail" value="true"/>
	    </call>
	
	    <try>
	        <sequence>
		        <exec executable="badcommand"/>
		        <fail>Previous command should have failed.</fail>
	        </sequence>
	        <catch exception="${java.IOException}">
	            <log>Failed as expected</log>
	        </catch>
	    </try>
    </component>
     
</script> 