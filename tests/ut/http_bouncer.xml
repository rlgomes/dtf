<?xml version="1.0" encoding="UTF-8"?>

<script xmlns="http://dtf.org/v1" name="http">
    <info>
        <author>
            <name>Rodney Gomes</name>
            <email>rlgomes@yahoo-inc.com</email>
        </author>
        <description>
        Simple unit test to validate that bouncer login works, currently will 
        require that you pass your username and password on the commandline to 
        run this test. 
        </description>
    </info>

    <local>
        <createstorage id="INPUT" path="${dtf.xml.path}/input"/>
        <createstorage id="OUTPUT" path="${dtf.xml.path}/output"/>
       
        <loadproperties uri="storage://INPUT/ut.properties"/>
        
        <property name="iterations" value="50" overwrite="true"/>
        <property name="perfrun" value="false"/>
        
        <property name="twiki.uri"
                  value="http://twiki.corp.yahoo.com/view/CCDI/DistributedTestingFramework"/>
    </local> 

    <!-- logs onto bouncer and retrieves the cookies necessary for
         authentication to any other bouncer authenticated yahoo service -->
    <bouncer_login user="${bouncer.username}"
                   password="${bouncer.password}"
                   cookiegroupid="bouncer_auth"/>
  
    <record uri="storage://OUTPUT/bouncer_http_requests.txt"> 
      
        <!-- good request -->
	    <http_get uri="${twiki.uri}"
	              onFailure="continue">
	        <cookiegroup refid="bouncer_auth"/>
	    </http_get>
	    <cat uri="storage://OUTPUT/output1.html" append="false">${http.get.body}</cat>
	    <if>
	       <neq op1="${http.get.status}" op2="200"/>
	       <then>
	           <fail>
	           Failed to retrieve page from ${twiki.uri},
	           got ${http.get.status} check output1.html for the response page.
	           </fail>
	       </then>
	    </if> 

        <!-- request without authentication and validate we get directed to 
             bouncer. -->
	    <http_get uri="${twiki.uri}"
	              onFailure="continue"/>
	    <cat uri="storage://OUTPUT/output2.html" append="false">${http.get.body}</cat>
	    <if>   
	       <!-- if we were correctly redirected to bouncer we'd get the 
	            Set-Cookie header along with that specific cookie. -->
	       <and>
		       <isset property="http.get.headerout.Set-Cookie"/> 
		       <eq op1="${http.get.headerout.Set-Cookie}" 
		           op2="BYHO=1; path=/login/; domain=.corp.yahoo.com; HttpOnly;"/>
	       </and>
	       <else>
	           <fail>
	           Should have been redirected to bouncer, 
	           check output2.html for the response page.
	           </fail>
	       </else>
	    </if> 
    </record>
     
</script>