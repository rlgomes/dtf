<?xml version="1.0" encoding="UTF-8"?>

<script xmlns="http://dtf.org/v1" name="http_cleanup_test">
    <info>
        <author>
            <name>Rodney Gomes</name>
            <email>rlgomes@yahoo-inc.com</email>
        </author>
        <description>
        Smal test to validate that HTTP connection clean up is done correctly 
        and doesn't result in the unavailability of the connection manager.
        </description>
    </info>

    <local>
        <createstorage id="INPUT" path="${dtf.xml.path}/input"/>
        <createstorage id="OUTPUT" path="${dtf.xml.path}/output"/>
       
        <loadproperties uri="storage://INPUT/ut.properties"/>
        
        <property name="dtf.http.port" value="33333"/>
        <property name="perfrun" value="false"/>
    </local>

    <parallel>
	    <http_server port="${dtf.http.port}">
            <http_listener path="/nada"/>
        </http_server>
        <try>
            <sequence>
	            <sleep time="2s"/>
			    <for property="i" range="1..3"> 
				    <for property="client" range="1..3"> 
				        <local>
	            	        <lockgroup>
	            	            <lockcomponent id="C1"/>
	            	            <lockcomponent id="C2"/>
	            	            <lockcomponent id="C3"/>
	            	        </lockgroup>
				        </local>
				
				        <component id="C${client}">
				            <http_get uri="http://localhost:${dtf.http.port}/nada"
                                      perfrun="true"/>
				        </component>
                        
				        <local>
            	            <unlockcomponent id="C1"/>
            	            <unlockcomponent id="C2"/>
            	            <unlockcomponent id="C3"/>
				        </local>
				    </for>
			    </for>
            </sequence>
            <finally>
                <http_server command="stop" port="${dtf.http.port}"/>
            </finally>
        </try>
    </parallel>

</script>    