<?xml version="1.0" encoding="UTF-8"?>

<script xmlns="http://dtf.org/v1" name="property_creation">
    <info>
        <author>
            <name>Rodney Gomes</name>
            <email>rodneygomes@gmail.com</email>
        </author>
        <description>
        This test stresses property creation and cloning with multiple threads
        in order to validate that things don't break witho an OutOfMemoryException
        when they should execute correctly.
        </description>
    </info>

    <local>
        <!-- create input/output storage interfaces -->
        <createstorage id="INPUT" path="${dtf.xml.path}/input" />
        <createstorage id="OUTPUT" path="${dtf.xml.path}/output" />
        
        <property name="agents" value="1" />
        <property name="threads" value="5" />
    </local>
    
    <for property="i" range="1..100000">
        <property name="property${i}" value="CACACACACACACACA"/>
    </for>

    <!-- communicate and lock down agent machines for test use -->
    <for range="1..${agents}" property="agent">
        <local>
            <lockcomponent id="DTFA${agent}" />
        </local>
    </for>
  
    <function name="function1" export="true">
        <distribute range="1..10" iterations="100"/>
    </function>

    <for property="iteration" range="1..20">
        <event name="total">
		    <for range="1..5000" property="i">
		        <property name="p${i}-${iteration}" value="2000"/>
		    </for> 
            
	        <parallelloop property="agent" range="[1..${agents}]">
	            <component id="DTFA${agent}">
                    <call function="function1"/>
	            </component>
	        </parallelloop>
        </event>
        
        <subtract op1="${total.stop}" op2="${total.start}" result="duration"/>
        <log>Iteration ${iteration} took ${duration}ms</log>
    </for>
    
</script>
